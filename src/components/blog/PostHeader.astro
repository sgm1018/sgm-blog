---
import { Calendar, Clock, Share2, Eye, BookOpen, TrendingUp } from 'lucide-astro';
import type { BlogPost } from '../../types/blog.types';
import { formatDate } from '../../lib/utils';
import Badge from '../ui/Badge.astro';
import ShareButtons from './ShareButtons.astro';

export interface Props {
  post: BlogPost;
}

const { post } = Astro.props;
---

<header class="mb-8">
  <!-- Breadcrumb -->
  <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-6">
    <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
      Inicio
    </a>
    <span class="mx-2">/</span>
    <a href="/blog" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
      Blog
    </a>
    <span class="mx-2">/</span>
    <span class="text-gray-900 dark:text-gray-100">{post.title}</span>
  </nav>

  <!-- Categorías y Tags -->
  <div class="flex flex-wrap gap-2 mb-6">
    <Badge 
      variant="primary" 
      size="md"
      class="text-white font-semibold"
    >
      {post.category.name}
    </Badge>
    
    {post.tags.map((tag) => (
      <Badge variant="default" size="sm">
        #{tag.name}
      </Badge>
    ))}
  </div>

  <!-- Título -->
  <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
    {post.title}
  </h1>

  <!-- Excerpt -->
  <p class="text-xl text-gray-600 dark:text-gray-400 leading-relaxed mb-8 max-w-3xl">
    {post.excerpt}
  </p>

  <!-- Imagen destacada -->
  {post.featuredImage && (
    <div class="mb-8 rounded-2xl overflow-hidden shadow-xl">
      <img
        src={post.featuredImage}
        alt={post.title}
        class="w-full h-64 md:h-96 object-cover"
        loading="eager"
      />
    </div>
  )}

  <!-- Meta información simplificada -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl">
    <!-- Post Statistics -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
      <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        <TrendingUp size={16} class="mr-2 text-primary-600" />
        Estadísticas del Post
      </h3>
      
      <div class="space-y-3">
        <!-- Fecha de publicación -->
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-600 dark:text-gray-400">
            <Calendar size={14} class="mr-2" />
            <span class="text-sm">Publicado</span>
          </div>
          <span class="text-sm font-medium text-gray-900 dark:text-white">
            {formatDate(post.publishedAt)}
          </span>
        </div>

        <!-- Tiempo de lectura -->
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-600 dark:text-gray-400">
            <Clock size={14} class="mr-2" />
            <span class="text-sm">Lectura</span>
          </div>
          <span class="text-sm font-medium text-gray-900 dark:text-white">
            {post.readingTime} min
          </span>
        </div>

        <!-- Vistas estimadas -->
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-600 dark:text-gray-400">
            <Eye size={14} class="mr-2" />
            <span class="text-sm">Vistas</span>
          </div>
          <span class="text-sm font-medium text-gray-900 dark:text-white">
            {post.views || 0}
          </span>
        </div>

        <!-- Última actualización (si aplica) -->
        {post.updatedAt !== post.publishedAt && (
          <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
              <BookOpen size={12} class="mr-2" />
              <span>Actualizado {formatDate(post.updatedAt)}</span>
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Share Actions -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
      <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        <Share2 size={16} class="mr-2 text-primary-600" />
        Compartir
      </h3>
      
      <ShareButtons 
        title={post.title}
        url={`${Astro.site}blog/${post.slug}`}
        excerpt={post.excerpt}
      />
    </div>
  </div>
</header>

<!-- Tabla de contenidos móvil -->
<div class="lg:hidden mb-8">
  <details class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4">
    <summary class="cursor-pointer font-semibold text-gray-900 dark:text-gray-100 flex items-center">
      <span class="mr-2">📑</span>
      Tabla de contenidos
    </summary>
    <div class="mt-4">
      <!-- El contenido será generado por JavaScript -->
      <div id="mobile-toc" class="space-y-2"></div>
    </div>
  </details>
</div>

<script>
  // Generar tabla de contenidos móvil
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.prose');
    const mobileToc = document.getElementById('mobile-toc');
    
    if (content && mobileToc) {
      const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
      
      headings.forEach((heading, index) => {
        const id = heading.id || `heading-${index}`;
        if (!heading.id) heading.id = id;
        
        const level = parseInt(heading.tagName.charAt(1));
        const link = document.createElement('a');
        link.href = `#${id}`;
        link.textContent = heading.textContent;
        link.className = `block text-sm hover:text-primary-600 dark:hover:text-primary-400 transition-colors pl-${(level - 1) * 4}`;
        
        mobileToc.appendChild(link);
      });
    }
  });
</script>
